Bud, this log is actually gold â€” it tells us exactly whatâ€™s happening.

Letâ€™s decode it cleanly.

âœ… Confirmed From Logs (Very Important)
âœ” get_totp_setup_ciphertext_admin
POST â†’ 200 OK


ğŸ‘‰ Function exists
ğŸ‘‰ Headers OK
ğŸ‘‰ Auth OK
ğŸ‘‰ Payload OK

So your connection to Supabase is working perfectly.

âŒ start_totp_setup_admin

You got:

Sometimes:
404 â†’ Function not found

Later:
400 â†’ Function exists BUT request invalid
proxy_status: PostgREST error=0A000


This combo tells us something very specific.

ğŸ§  What This Pattern Means
Phase 1 â†’ 404

Earlier request:

content_length = 0


ğŸ‘‰ You sent NO BODY

RPC expects JSON â†’ you sent nothing â†’
PostgREST sometimes returns 404 when function signature doesn't match.

Phase 2 â†’ 400 (THIS IS GOOD NEWS)

Now:

content_length = 129


ğŸ‘‰ You ARE sending body
ğŸ‘‰ Function EXISTS
ğŸ‘‰ Now database is rejecting INPUT â†’ 400

ğŸ”¥ This means you are now hitting correct function.

â­ Root Cause NOW

Not endpoint.
Not headers.
Not auth.

ğŸ‘‰ Payload format wrong
ğŸ‘‰ Missing parameter
ğŸ‘‰ Wrong type (uuid vs text vs json)

ğŸš¨ The Smoking Gun In Your Log
PostgREST error = 0A000


In PostgreSQL â†’ 0A000 =

Feature not supported / wrong function usage


Usually means:

Named parameters mismatch

Function overload mismatch

JSON structure mismatch

âœ… MOST LIKELY ISSUE

Your function probably expects:

(user_uuid uuid, secret_cipher text)


But you might be sending:

string instead of uuid
OR
missing secret_cipher
OR
wrong field names

ğŸ”¥ VERY IMPORTANT TEST (Do This)

Run in SQL editor:

select
proname,
pg_get_function_identity_arguments(p.oid)
from pg_proc p
join pg_namespace n on n.oid = p.pronamespace
where proname = 'start_totp_setup_admin';

âœ… Expected Output Example
start_totp_setup_admin
(user_uuid uuid, secret_cipher text)


If you see something like:

(jsonb)


or

(user_uuid text)


Then payload must match EXACTLY.

ğŸš€ Example If Function Is
(user_uuid uuid, secret_cipher text)


Payload MUST be:

{
  "user_uuid": "uuid-here",
  "secret_cipher": "base64"
}

âš  Another Possibility

Function expects:

jsonb


Then payload must be:

{
  "p_user_uuid": "...",
  "p_secret_cipher": "..."
}


(depends how function defined)

ğŸ§ª Why Other RPC Works

Because:

get_totp_setup_ciphertext_admin


Probably takes only:

user_uuid


So easier to match.

ğŸ§  My Confidence Guess

Payload mismatch â†’ 70%
Wrong parameter names â†’ 20%
Wrong types â†’ 10%

ğŸš€ FASTEST WAY FORWARD

Paste result of:

select
proname,
pg_get_function_identity_arguments(p.oid)
from pg_proc p
join pg_namespace n on n.oid = p.pronamespace
where proname ilike '%totp%';


Then Iâ€™ll build exact PowerShell one-liner that WILL work.

Youâ€™re honestly very close now, bud. This is final-stage debugging.

i get this:[
  {
    "proname": "start_totp_setup_admin",
    "pg_get_function_identity_arguments": "user_uuid uuid, secret_cipher text"
  }
][ 
  {
    "proname": "start_totp_setup_admin",
    "pg_get_function_identity_arguments": "user_uuid uuid, secret_cipher text"
  },
  {
    "proname": "get_totp_setup_ciphertext_admin",
    "pg_get_function_identity_arguments": "user_uuid uuid"
  },
  {
    "proname": "confirm_totp_setup_admin",
    "pg_get_function_identity_arguments": "user_uuid uuid"
  },
  {
    "proname": "get_totp_ciphertext_for_login_admin",
    "pg_get_function_identity_arguments": "user_uuid uuid"
  },
  {
    "proname": "start_totp_setup",
    "pg_get_function_identity_arguments": "secret_cipher text"
  },
  {
    "proname": "get_totp_setup_ciphertext",
    "pg_get_function_identity_arguments": ""
  },
  {
    "proname": "confirm_totp_setup",
    "pg_get_function_identity_arguments": ""
  },
  {
    "proname": "get_totp_ciphertext_for_login",
    "pg_get_function_identity_arguments": ""
  }
]

Ah, I see whatâ€™s happening, bud. From your output, your Supabase/PostgreSQL database has two sets of TOTP-related functions: one for admins and one for regular users. Hereâ€™s the breakdown:

Admin TOTP functions
Function	Arguments
start_totp_setup_admin	user_uuid uuid, secret_cipher text
get_totp_setup_ciphertext_admin	user_uuid uuid
confirm_totp_setup_admin	user_uuid uuid
get_totp_ciphertext_for_login_admin	user_uuid uuid

Admin TOTP functions require the user_uuid, because theyâ€™re tied to a specific admin account.

Regular user TOTP functions
Function	Arguments
start_totp_setup	secret_cipher text
get_totp_setup_ciphertext	(no arguments)
confirm_totp_setup	(no arguments)
get_totp_ciphertext_for_login	(no arguments)

Regular user TOTP functions either have no arguments or only secret_cipher. They are not tied to a specific UUID in the function call.

Why your POST requests fail

You were calling /rpc/start_totp_setup_admin with your payload, but if the user_uuid or secret_cipher is missing or incorrect, you get 400 or 404.

Calling /rpc/get_totp_setup_ciphertext_admin works (200) because the function exists and you likely passed a valid user_uuid.

How to fix the â€œonly show QR onceâ€ behavior

Use the get function first:

get_totp_setup_ciphertext_admin(user_uuid) â€” returns the encrypted secret if TOTP is already set.

If it exists â†’ skip showing QR, only ask for 6-digit code on login.

If it doesnâ€™t exist â†’ call start_totp_setup_admin(user_uuid, secret_cipher) to generate QR for enrollment.