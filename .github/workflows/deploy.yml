name: Deploy C2 Controller
on:
  push:
    branches: [ main ]
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Bandit Security Scan
        continue-on-error: true
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json
      - name: Summarize Bandit results and fail on HIGH severity
        run: |
          python - <<'PY'
          import json, sys
          try:
              with open('bandit-report.json') as f:
                  r = json.load(f)
          except FileNotFoundError:
              print("bandit-report.json not found; Bandit may have failed before writing output.")
              sys.exit(1)
          results = r.get('results', [])
          high = [i for i in results if i.get('issue_severity') == 'HIGH']
          if high:
              print("Bandit HIGH severity findings:")
              for i in high:
                  print(f"{i.get('test_id')} {i.get('filename')}:{i.get('line_number')} - {i.get('issue_text')}")
              sys.exit(1)
          else:
              print(f"Bandit findings: {len(results)} total, {len(high)} HIGH")
          PY
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json
      - name: Run Safety Check
        run: |
          pip install safety
          safety check -r requirements-controller.txt
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install -r requirements-controller.txt
      - name: Run tests
        env:
          EVENTLET_MONKEY_PATCH: "0"
          SOCKET_ASYNC_MODE: "threading"
          DATABASE_URL: "sqlite:///:memory:"
        run: python -m pytest -q tests
  deploy:
    needs: [security-scan, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" -H "Authorization: Bearer $RENDER_API_KEY"
